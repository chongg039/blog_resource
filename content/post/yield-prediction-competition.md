---
title: "天池全球数据智能大赛（赛场二）第7名解决方案"
date: 2019-10-22T19:46:49+08:00
Description: ""
Tags: [python, ML]
Categories: [Competition]

---

第一次正儿八经组队参加的比赛，虽然没能拿到奖金但也取得了一个比较满意的成绩（初赛23复赛7），这里记录一下当时的解决思路。

首先这是一个农作物产量预测的比赛，属于比较传统的回归分析，这种类型的比赛只要做好 EDA ，一般都能取得不错的成绩，而不是说设计了一个多么精妙的网络结构。事实上官方提供的数据集最大的问题就是少，而且样本分布严重不均，这也成为了赛后受大家诟病的一个主要方面。

### 探索性数据分析（EDA）

#### EDA of train data

取以下数值型天气特征并分析之间的相关性：

```json
{
    "日照时数（单位：h)": "day_sun_hour",
    "日平均风速(单位：m/s)": "day_mean_wind",
    "日降水量（mm）": "day_rain",
    "日平均温度（单位：℃）": "day_mean_temperature",
    "日相对湿度（单位：%）": "day_relative_humidity",
    "日平均气压（单位：hPa）": "day_mean_pressure",
    "日最高温度（单位：℃）": "day_high_temp",
    "日最低温度（单位：℃）": "day_low_temp"
}
```
以2017年区县id为16的地区为例：

![2017年county16的某些天气特征](https://live.staticflickr.com/65535/48793272876_f8194965a1_z.jpg#center)

可以得出：

1. 一个地区一年的日平均温度、日最高温度和日最低温度呈正相关；
2. 以平均温度为例，日平均气压与日平均温度呈负相关。

取以下类别型天气特征并处理：

```json
{
    "02时风向": "day_02_wind",
    "08时风向": "day_08_wind",
    "14时风向": "day_14_wind",
    "20时风向": "day_20_wind"
}
```

做连续特征的话，依据下面的映射表映射到数值特征上：

```json
{
    "N": 0,
    "NNE": 22.5,
    "NE": 45,
    "ENE": 67.5,
    "E": 90,
    "ESE": 112.5,
    "SE": 135,
    "SSE": 157.5,
    "S": 180,
    "SSW": 202.5,
    "SW": 225,
    "WSW": 247.5,
    "W": 270,
    "WNW": 295.5,
    "NW": 315,
    "NNW": 337.5,
    "C": 0
}
```

使用虚拟变量的话，则需要使用 17 维特征表示一个风向特征，纬度太大抛弃该方案。

实际项目中，考虑到总体特征的维度关系，不使用风向特征。

#### EDA of label

下图为 2015、2016、2017 三年的产量分布图，左侧为早稻，右侧为晚稻：

![三年早稻产量分布](https://live.staticflickr.com/65535/48793328157_a193b6c824.jpg)![三年晚稻产量分布](https://live.staticflickr.com/65535/48792821458_9f5d49791e.jpg)

可以看出：

1. 每年早稻、晚稻绝对产量的分布变化不大；
2. 早晚稻的分布都近似一个右偏的高斯分布，不适合模型学习；

针对以上问题，需要让模型学习到两年产量的一个差值，并且让分布趋近标准正态分布。分别对早稻和晚稻做两年的差值：

![2016-2015和2017-2016早稻产量](https://live.staticflickr.com/65535/48793186206_9d436c4b6c.jpg)![2016-2015和2017-2016晚稻产量](https://live.staticflickr.com/65535/48793327762_a83e076304.jpg)

让模型去学习两年之间早稻（或晚稻）的差异，这个差异的分布也要更接近于对称的正态分布。因此预测 2018 年数据得到的结果需要加上 2017 年的产量才是真实预测出的 2018 年的产量。

[^1]: 对于预测差值，同样考虑过减去三年均值的情况，尽管相比于上述方案增加了训练数据，但初赛对于早稻的预测效果并不好，而且不合理，因此采用了上面的方案。
[^2]: 对于晚稻的情况，从上面右侧的图中可以看出有一个异常值大幅偏离预估的分布，这将会在数据预处理中解决。

### 数据预处理与特征选取

首先去掉了原始数据中的脏数据。

根据训练数据的 EDA ，选取以下 5 个数值型特征作为训练特征：

1. 日照时数
2. 日平均风速
3. 日降水量
4. 日平均温度
5. 日相对湿度

在尽可能保留信息的同时降低多重线性的影响。

对于月份，选取 3、4、5、6、7 月的训练数据作为早稻的特征，选取 7、8、9、10、11 月的训练数据作为晚稻的特征。

得到一年的特征则主要有两个方案，一种是将早稻（或晚稻）对应几个月份的各个特征取平均作为该县该年的天气特征（5维），另一种是分别对每个月份的各个特征取平均，再将所有月份的特征拼接起来（25维）作为该县该年的天气特征。经过初赛的多次试验后发现差别不大，为了减少特征纬度过高带来的过拟合的影响，最终采用的是 5 维的特征。

[^3]: 对于天气特征，考虑过是否需要减去天气的均值，用天气的差值做特征来分析。最终因初赛该方案的表现不够理想而放弃。对于地区差异，尝试过加入区县 id 当作地区之间的土壤差异特征，效果提升不大，同样放弃，最终只采用了原始的 5 维天气特征。

对于任意两年晚稻的差异，由下图可以看出，2015 年和 2016 年各个区县自己的晚稻产量差异不大，而 2016 年和 2017 年晚稻的差异中可以发现，区县 id 为 16 的地区发生了明显的波动。继续将 2015 年和 2017 年晚稻产量对比，仍然出现了异常波动的情况。

通过检查该地区的具体晚稻产量的值，发现 2017 年该地区晚稻的产量有大幅的下滑。在查询广西这三年的天气报告后，我们将其视为一个其他原因导致的异常值，并在训练时对其做了处理，将其转换为该地区前两年晚稻的均值。

![2015和2016各个县的晚稻产量](https://live.staticflickr.com/65535/48792821613_5f067dc7ae.jpg)![2015和2017各个县的晚稻产量](https://live.staticflickr.com/65535/48793327947_d08346fdf3.jpg)![2016和2017各个县的晚稻产量](https://live.staticflickr.com/65535/48793327877_0b9376a3e2.jpg)

### 模型选择

在 ./code/model.py 文件中有 Models 类，支持以下几种回归模型：

1. 线性回归模型
2. SVM 回归模型，使用线性核函数
3. SVM 回归模型，使用径向基核函数
4. GBDT 回归模型

所有模型的超参数已通过网格搜索得到最优组合，不要轻易改动

最终提交的版本中，线上得到的早稻的最优结果使用的是线性核函数的 SVM 回归模型，晚稻的最优结果使用的是径向基核函数的 SVM 回归模型。

### 后记

尽管比赛本身有着诸多不足，但总体来说还是一次比较成功的体验，和强哥还有彬彬的合作也非常融洽。个人从中主要学到的还是如何分析数据、处理数据，认识到了一次好的先期数据探索性分析能够起到多么重要的作用。自己以后比较希望寻找算法转开发性质的工作，希望能将研究生期间学到的专业知识，以及在项目实际处理中积累的经验结合起来，因此之后还是希望尽量多参加一下这样有比较真实数据，且有实际意义的赛事。

